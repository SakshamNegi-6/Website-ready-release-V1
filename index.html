<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Himachal Quiz Challenge</title>
  <meta name="description" content="A dynamic CBSE-style quiz about Himachal Pradesh." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    /* ---
      HIMACHAL QUIZ CHALLENGE (v38.0 - Dynamic UI & Audio Update)
      - NEW: Hero image is now dynamic, changing from sun to moon based on user's time.
      - NEW: Added "Good Night" to personalized greetings.
      - IMPROVED: Replaced all sound effects with new, more pleasant and modern sounds.
      - Copyright (c) 2025 Saksham Negi
    --- */

    :root {
      --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-display: 'Orbitron', sans-serif;
      --base-font-size: 16px; --large-font-size: 18px;
      
      --bg-light: #f4f4f9; --card-bg-light: #ffffff; --card-bg-light-rgb: 255, 255, 255; --card-border-light: rgba(0, 0, 0, 0.1);
      --text-primary-light: #1d1d1f; --text-secondary-light: #6e6e73; --accent-light: #007aff; --accent-light-rgb: 0, 122, 255;
      
      --bg-dark: #111217; --card-bg-dark: #1c1d23; --card-bg-dark-rgb: 28, 29, 35; --card-border-dark: rgba(255, 255, 255, 0.15);
      --text-primary-dark: #f5f5f7; --text-secondary-dark: #a1a1a6; --accent-dark: #00f2fe; --accent-dark-rgb: 0, 242, 254;

      --glow-correct: #32d74b; --glow-incorrect: #ff453a; --gold: #ffc900; --silver: #d1d1d6; --bronze: #d99a75;
      --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1); --transition-medium: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow-md: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    [data-theme="light"] {
      --bg: var(--bg-light); --card-bg: var(--card-bg-light); --card-bg-rgb: var(--card-bg-light-rgb); --card-border: var(--card-border-light);
      --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light);
      --accent: var(--accent-light); --accent-rgb: var(--accent-light-rgb);
    }
    [data-theme="dark"] {
      --bg: var(--bg-dark); --card-bg: var(--card-bg-dark); --card-bg-rgb: var(--card-bg-dark-rgb); --card-border: var(--card-border-dark);
      --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark);
      --accent: var(--accent-dark); --accent-rgb: var(--accent-dark-rgb);
    }

    *, *::before, *::after { 
        box-sizing: border-box;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; 
    }
    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-primary); background-color: var(--bg); color: var(--text-primary);
      display: flex; align-items: center; justify-content: center;
      transition: background-color var(--transition-medium), color var(--transition-medium); font-size: var(--base-font-size);
      padding: 16px;
    }
    html.large-text { font-size: var(--large-font-size); }
    html.modal-open, body.modal-open { overflow: hidden; }

    .background-aurora {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      background: radial-gradient(circle at 10% 20%, rgba(var(--accent-rgb), 0.1), transparent 35%), radial-gradient(circle at 80% 70%, rgba(var(--accent-rgb), 0.1), transparent 35%);
      animation: aurora-flow 20s infinite ease-in-out alternate; transition: opacity var(--transition-medium);
    }
    .aurora-flash-correct { animation: flash-correct 0.8s ease-out; }
    .aurora-flash-incorrect { animation: flash-incorrect 0.8s ease-out; }
    @keyframes aurora-flow { from { transform: rotate(0deg) scale(1); } to { transform: rotate(360deg) scale(1.2); } }
    @keyframes flash-correct { from { background-color: rgba(50, 215, 75, 0.2); } to { background-color: transparent; } }
    @keyframes flash-incorrect { from { background-color: rgba(255, 69, 58, 0.2); } to { background-color: transparent; } }

    .screen {
      width: 100%;
      max-width: 680px;
      height: 100%;
      max-height: 850px;
      height: 100svh;
      display: none;
      flex-direction: column;
      transition: opacity 0.3s ease-out;
      pointer-events: none;
    }
    .screen.show {
        display: flex;
        opacity: 1;
    }

    .container {
      background-color: rgba(var(--card-bg-rgb), 0.75);
      border: 1px solid var(--card-border); 
      -webkit-backdrop-filter: blur(40px); 
      backdrop-filter: blur(40px);
      border-radius: 32px; box-shadow: var(--shadow-md); padding: clamp(16px, 5vw, 32px); display: flex; flex-direction: column;
      text-align: center; flex-grow: 1; position: relative;
      overflow: hidden;
    }
    .scrollable-content {
        overflow-y: auto;
        height: 100%;
        padding-right: 10px;
        margin-right: -10px;
    }
    .scrollable-content::-webkit-scrollbar { display: none; }
    .scrollable-content { -ms-overflow-style: none; scrollbar-width: none; }
    
    .container::before {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 32px; padding: 1px;
        background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.5), rgba(var(--accent-rgb), 0));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude; animation: rotate-border 4s infinite linear;
        pointer-events: none;
    }
    @keyframes rotate-border { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23ffffff' fill-opacity='0.05' d='M0,224L48,208C96,192,192,160,288,165.3C384,171,480,213,576,240C672,267,768,277,864,256C960,235,1056,181,1152,154.7C1248,128,1344,128,1392,128L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
        background-size: cover;
        background-repeat: no-repeat;
        z-index: 0;
        opacity: 0.5;
        pointer-events: none;
    }
    [data-theme="dark"] .container::after {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%2300f2fe' fill-opacity='0.05' d='M0,224L48,208C96,192,192,160,288,165.3C384,171,480,213,576,240C672,267,768,277,864,256C960,235,1056,181,1152,154.7C1248,128,1344,128,1392,128L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
    }


    .container-header { margin-bottom: 24px; z-index: 1; }
    .container-main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; z-index: 1; }
    .container-footer { margin-top: 24px; z-index: 1; }
    h1 { font-size: clamp(1.75rem, 5vw, 2.25rem); font-weight: 800; margin: 0 0 8px; }
    h2 { font-size: 1.125rem; color: var(--text-secondary); margin: 0; font-weight: 400; }
    p { color: var(--text-secondary); line-height: 1.6; font-size: 1rem; }

    button, input, .welcome-options a {
      outline: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .main-btn, .secondary-btn, .danger-btn { display: inline-flex; justify-content: center; align-items: center; width: 100%; max-width: 320px; padding: 16px; border-radius: 16px; font-size: 1.125rem; font-weight: 600; border: none; cursor: pointer; transition: transform var(--transition-fast), box-shadow var(--transition-fast); user-select: none; }
    .main-btn:active, .secondary-btn:active, .danger-btn:active { transform: scale(0.97); animation: button-pop 0.2s; }
    @keyframes button-pop { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
    .main-btn { background-color: var(--accent); color: var(--bg-dark); box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.3); }
    .main-btn:hover { box-shadow: 0 6px 25px rgba(var(--accent-rgb), 0.4); transform: translateY(-2px); }
    .secondary-btn { background-color: rgba(120,120,128,0.24); color: var(--text-primary); }
    .danger-btn { background-color: var(--glow-incorrect); color: #fff; }

    /* --- Welcome Screen Specific --- */
    #welcome-screen .container-header { margin-bottom: 16px; }
    .hero-image { width: 100%; max-width: 250px; height: auto; margin: -16px auto 16px; display: block; }
    .hero-image #sun-moon { transform-origin: center; transition: cy 1s ease-in-out, fill 1s ease-in-out; }
    .hero-image #mountains path { animation: float 6s infinite ease-in-out; }
    .hero-image #mountains path:nth-child(2) { animation-delay: -2s; }
    .hero-image #mountains path:nth-child(3) { animation-delay: -4s; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    #dynamic-greeting { color: var(--text-secondary); font-weight: 600; margin: 0 0 8px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .quiz-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 8px; margin-bottom: 16px; }
    #round-title { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); }
    #streak-counter { background-color: rgba(255, 149, 0, 0.8); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.875rem; font-weight: 600; transform: scale(0); transition: transform var(--transition-medium); }
    #streak-counter.visible { transform: scale(1); }
    #progress-bar-container { width: 100%; background: rgba(120,120,128,0.24); border-radius: 10px; height: 8px; margin-bottom: 30px; overflow: hidden; }
    #progress-bar { height: 100%; width: 0%; background: var(--accent); border-radius: 10px; transition: width 0.5s cubic-bezier(0.65, 0, 0.35, 1); }
    
    @keyframes question-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .question { font-size: clamp(1.25rem, 4vw, 1.5rem); font-weight: 600; line-height: 1.4; margin: 0 0 24px; overflow-wrap: break-word; }

    .options {
        display: flex;
        flex-direction: column;
    }
    .options button { 
      width: 100%; 
      padding: 16px; 
      margin: 8px 0; 
      font-size: 1rem; 
      font-weight: 600; 
      text-align: left; 
      border: 1px solid var(--card-border); 
      border-radius: 12px; 
      background-color: transparent; 
      color: var(--text-primary); 
      cursor: pointer; 
      transition: all var(--transition-fast); 
      overflow-wrap: break-word; 
    }
    .options button:not(:disabled):hover { background-color: rgba(var(--accent-rgb), 0.1); border-color: var(--accent); transform: scale(1.02); }
    .options button.correct { background-color: rgba(50, 215, 75, 0.2); border-color: var(--glow-correct); color: var(--text-primary) !important; transform: scale(1.02); animation: correct-answer-pop 0.5s ease-out; }
    @keyframes correct-answer-pop { 0% { transform: scale(1.02); } 50% { transform: scale(1.05); } 100% { transform: scale(1.02); } }
    .options button.incorrect { background-color: rgba(255, 69, 58, 0.2); border-color: var(--glow-incorrect); }
    .options button.answered:not(.correct) { opacity: 0.5; transform: scale(0.98); }
    .options button.faded { opacity: 0.3 !important; pointer-events: none; }
    .options button:disabled { cursor: not-allowed; }

    #feedback-area { min-height: 48px; margin-top: 20px; font-size: 1.125rem; font-weight: 600; transform: scale(0.8); opacity: 0; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;}
    #feedback-area.visible { animation: feedback-pop-in 0.5s forwards; }
    @keyframes feedback-pop-in { 0% { transform: scale(0.8); opacity: 0; } 70% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #feedback-area.correct { color: var(--glow-correct); }
    #feedback-area.incorrect { color: var(--glow-incorrect); }
    .explain-btn { padding: 6px 12px; font-size: 0.9rem; max-width: 150px; margin-top: 0; height: auto; }
    #hint-btn, #powerup-5050-btn { padding: 6px 12px; font-size: 0.9rem; max-width: 150px; margin: 16px 5px 0; height: auto; display: none; }
    .powerup-container { display: flex; justify-content: center; }

    #timer-bar-container { width: 100%; background: rgba(120,120,128,0.24); border-radius: 10px; height: 8px; margin-top: 20px; overflow: hidden; display: none; }
    #timer-bar { height: 100%; width: 100%; background: var(--glow-incorrect); border-radius: 10px; }
    
    .medal-display { font-size: 80px; margin: 0 auto 16px; transform: scale(0); opacity: 0;}
    .medal-display.animate { animation: pop-in-medal 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    #final-badge { font-size: 1.5rem; font-weight: 800; transform: scale(0); opacity: 0;}
    #final-badge.animate { animation: pop-in-medal 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards; }
    @keyframes pop-in-medal { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
    
    #final-badge.gold { color: var(--gold); } #final-badge.silver { color: var(--silver); } #final-badge.bronze { color: var(--bronze); }
    #score-display-area { margin: 24px 0; font-size: 1rem; text-align: left; opacity: 0; transform: translateY(10px); }
    #score-display-area.animate { animation: fade-in-up 0.5s ease-out 0.4s forwards; }
    .score-breakdown > div { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--card-border); }
    .score-breakdown > div:last-child { border: none; }
    .score-value { font-weight: 600; } 
    #final-score-value { font-size: 1.25rem; color: var(--accent); }
    
    .results-buttons, #save-score-container, #results-leaderboard-area { opacity: 0; transform: translateY(10px); }
    #save-score-container.animate { animation: fade-in-up 0.5s ease-out 0.6s forwards; }
    #results-leaderboard-area.animate { animation: fade-in-up 0.5s ease-out 0.7s forwards; }
    .results-buttons.animate { animation: fade-in-up 0.5s ease-out 0.8s forwards; }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .results-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
    .results-buttons button { width: 100%; max-width: none; }

    .leaderboard { margin-top: 24px; text-align: left; }
    .leaderboard h3 { font-size: 1rem; text-align: center; color: var(--text-secondary); margin-bottom: 12px; }
    .leaderboard ol { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .leaderboard li { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 10px; background-color: rgba(120,120,128,0.12); font-size: 0.9rem; }
    .leaderboard li:nth-child(1)::before { content: 'ðŸ¥‡'; margin-right: 8px; } .leaderboard li:nth-child(2)::before { content: 'ðŸ¥ˆ'; margin-right: 8px; } .leaderboard li:nth-child(3)::before { content: 'ðŸ¥‰'; margin-right: 8px; }
    .leaderboard .score { font-weight: 600; }

    #save-score-area { display: flex; gap: 10px; margin: 20px 0; }
    #save-score-area input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--card-border); background: rgba(120,120,128,0.12); color: var(--text-primary); font-size: 1rem; }
    #save-score-area button { padding: 12px 20px; border-radius: 12px; border: none; background: var(--accent); color: var(--bg-dark); cursor: pointer; font-weight: 600; }

    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity var(--transition-medium); z-index: 2000; }
    #modal-overlay.show { opacity: 1; pointer-events: auto; }
    #modal-overlay .container { 
      background-color: var(--card-bg); transform: scale(0.95) translateY(20px); transition: transform 0.3s ease-out, opacity 0.3s ease-out; max-height: 90vh;
    }
    #modal-overlay.show .container { transform: scale(1) translateY(0); }
    .modal-close-btn { position: absolute; top: 16px; right: 16px; font-size: 28px; color: var(--text-secondary); background: none; border: none; cursor: pointer; z-index: 10; }
    .modal-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 24px; }
    .modal-input { display: block; width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--card-border); background: rgba(120,120,128,0.24); color: var(--text-primary); font-size: 1rem; margin-top: 16px; }
    #modal-validation-message { color: var(--glow-incorrect); font-size: 0.9rem; height: 1.2em; margin-top: 8px; }
    .study-guide { text-align: left; } .study-guide ul { padding-left: 0; list-style: none; } 
    .study-guide li { display: flex; align-items: flex-start; margin-bottom: 12px; opacity: 0; animation: fade-in-up 0.5s ease-out forwards; }
    .study-guide li span { margin-right: 12px; font-size: 1.2rem; }

    .welcome-options { margin-top: 32px; display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; }
    .welcome-options a { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 90px; height: 90px; background-color: rgba(120,120,128,0.12); border-radius: 24px; color: var(--text-secondary); text-decoration: none; font-size: 0.8rem; font-weight: 600; transition: transform var(--transition-fast), background-color var(--transition-fast); }
    .welcome-options a:hover { transform: translateY(-4px); background-color: rgba(120,120,128,0.24); color: var(--text-primary); }
    .welcome-options a svg { width: 28px; height: 28px; margin-bottom: 8px; stroke-width: 2; }
    
    /* Settings Modal Styles */
    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 8px;
        border-bottom: 1px solid var(--card-border);
        font-size: 1rem;
    }
    .settings-row:last-of-type {
        border-bottom: none;
    }
    .settings-row[data-clickable="true"] {
        cursor: pointer;
        transition: background-color var(--transition-fast);
    }
    .settings-row[data-clickable="true"]:hover {
        background-color: rgba(var(--accent-rgb), 0.08);
    }
    .scrollable-content h3 {
        text-align: left;
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin: 24px 8px 8px;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(120,120,128,0.24); transition: var(--transition-fast); border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-fast); border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(22px); }
    
    .review-question-item { text-align: left; padding: 16px; margin-bottom: 12px; border: 1px solid var(--card-border); border-radius: 12px; }
    .review-question-item h4 { margin: 0 0 12px; font-size: 1rem; }
    .review-option { display: block; padding: 8px; border-radius: 8px; margin: 4px 0; font-size: 0.9rem; }
    .review-option.correct-answer { background-color: rgba(50, 215, 75, 0.2); }
    .review-option.user-incorrect { background-color: rgba(255, 69, 58, 0.2); text-decoration: line-through; }

    .gemini-feature {
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 16px;
        margin-top: 24px;
        background-color: rgba(var(--accent-rgb), 0.05);
    }
    .gemini-feature h3 {
        margin: 0 0 8px;
        font-size: 1rem;
        color: var(--accent);
    }
    .gemini-feature p {
        font-size: 0.9rem;
        margin: 0;
    }
    
    #mascot {
        position: fixed;
        bottom: 15px;
        left: 15px;
        width: 100px;
        height: auto;
        transform: translateY(200%);
        z-index: 100;
        pointer-events: none;
    }
    #mascot.show {
        animation: mascot-bounce-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes mascot-bounce-in {
        0% { transform: translateY(200%) scale(0.5); }
        60% { transform: translateY(-10px) scale(1.05); }
        100% { transform: translateY(0) scale(1); }
    }
    
    #mascot-message {
        position: absolute;
        bottom: 95%;
        left: 50%;
        transform: translateX(-50%) scale(0);
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        font-size: 0.9rem;
        font-weight: 600;
        width: max-content;
        max-width: 200px;
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease;
    }
     #mascot.show-message #mascot-message {
        transform: translateX(-50%) scale(1);
        opacity: 1;
    }

    .eye {
        transform-box: fill-box;
        transform-origin: center;
        animation: blink 4s infinite ease-in-out;
    }
    .eye.right {
        animation-delay: 0.3s;
    }
    @keyframes blink {
        0%, 90%, 100% { transform: scaleY(1); }
        95% { transform: scaleY(0.1); }
    }

    #gyan-right-arm {
      transform-origin: 80px 65px;
    }

    #mascot.waving #gyan-right-arm {
      animation: wave-hello 1.5s infinite ease-in-out 0.8s;
    }
    @keyframes wave-hello {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(25deg); }
      75% { transform: rotate(-15deg); }
    }


    #toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translate(-50%, -150%);
        color: white;
        padding: 12px 24px;
        border-radius: 100px;
        font-weight: 600;
        z-index: 3000;
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    #toast.streak { background-color: rgba(255, 149, 0, 0.9); }
    #toast.perfect { background-color: rgba(var(--accent-rgb), 0.9); }
    #toast.show {
        transform: translate(-50%, 0);
    }

    #top-score-highlight {
        margin: 24px auto 0;
        padding: 12px 20px;
        background-color: rgba(var(--accent-rgb), 0.1);
        border: 1px solid rgba(var(--accent-rgb), 0.2);
        border-radius: 16px;
        max-width: 320px;
    }
    #top-score-highlight p {
        margin: 0;
        color: var(--accent);
        font-weight: 600;
        font-size: 0.9rem;
    }
    #top-score-highlight span {
        font-weight: 400;
        color: var(--text-secondary);
    }


    body.reduce-motion * { animation: none !important; transition-duration: 0.01s !important; }
  </style>
  <script>
    // Self-executing function to apply theme on initial load
    (() => {
      try {
        const settings = JSON.parse(localStorage.getItem('quizSettings')) || { theme: 'auto' };
        if (settings.theme === 'auto') {
          document.documentElement.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-theme', settings.theme);
        }
      } catch (e) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>
</head>
<body>
  <div class="background-aurora"></div>
  <div id="toast"></div>
  <div id="mascot">
    <div id="mascot-message">Well done!</div>
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g id="gyan-body">
        <!-- Body -->
        <path d="M25 90 C20 70, 20 50, 25 35 H 75 C 80 50, 80 70, 75 90 Z" fill="#E0E0E0"/>
        <path d="M30 88 C25 70, 25 50, 30 40 H 70 C 75 50, 75 70, 70 88 Z" fill="white"/>
        
        <!-- Arms -->
        <g id="gyan-left-arm">
          <circle cx="20" cy="65" r="10" fill="#E0E0E0" />
          <circle cx="18" cy="65" r="7" fill="#4DD0E1" />
        </g>
        <g id="gyan-right-arm">
          <circle cx="80" cy="65" r="10" fill="#E0E0E0" />
          <circle cx="82" cy="65" r="7" fill="#4DD0E1" />
        </g>

        <!-- Head -->
        <path d="M30 40 C 25 20, 30 5, 50 5 C 70 5, 75 20, 70 40 Z" fill="#FFFFFF"/>
        <!-- Ears -->
        <path d="M30 20 L 20 5 L 35 15 Z" fill="#FFFFFF" stroke="#BDBDBD" stroke-width="2" stroke-linejoin="round"/>
        <path d="M70 20 L 80 5 L 65 15 Z" fill="#FFFFFF" stroke="#BDBDBD" stroke-width="2" stroke-linejoin="round"/>
        <path d="M32 19 L 25 8 L 36 15 Z" fill="#4DD0E1" />
        <path d="M68 19 L 75 8 L 64 15 Z" fill="#4DD0E1" />

        <!-- Visor -->
        <path d="M35 38 C 30 25, 40 18, 50 18 C 60 18, 70 25, 65 38 Z" fill="#212121"/>
        
        <!-- Eyes -->
        <circle class="eye left" cx="45" cy="28" r="4" fill="#00E5FF"/>
        <circle class="eye right" cx="55" cy="28" r="4" fill="#00E5FF"/>
        
        <!-- Mouth on visor -->
        <path id="mouth" d="M48 35 C 49 36, 51 36, 52 35" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
      </g>
    </svg>
  </div>


  <main id="welcome-screen" class="screen">
    <div class="container">
     <div class="scrollable-content">
      <header class="container-header">
        <div class="hero-image">
            <svg viewBox="0 0 100 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop id="skyStop1" offset="0%" stop-color="#87CEEB" style="transition: stop-color 1s ease-in-out;"/>
                        <stop id="skyStop2" offset="100%" stop-color="#FFFFFF" style="transition: stop-color 1s ease-in-out;"/>
                    </linearGradient>
                    <filter id="glow">
                      <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
                      <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>
                </defs>
                <rect id="sky" width="100" height="70" fill="url(#skyGradient)" />
                <g id="stars" style="opacity: 0; transition: opacity 1s ease-in-out;">
                    <circle cx="20" cy="15" r="0.8" fill="white"/> <circle cx="30" cy="30" r="0.5" fill="white"/> <circle cx="40" cy="10" r="1" fill="white"/>
                    <circle cx="60" cy="20" r="0.8" fill="white"/> <circle cx="75" cy="12" r="0.5" fill="white"/> <circle cx="85" cy="25" r="1" fill="white"/>
                </g>
                <circle id="sun-moon" cx="50" cy="40" r="12" filter="url(#glow)"/>
                <g id="mountains">
                    <path d="M-5 70 L20 40 L45 60 L65 35 L80 50 L105 30 V 70 H-5Z" fill="rgba(var(--accent-rgb), 0.2)" />
                    <path d="M-5 70 L15 45 L35 62 L55 40 L75 58 L105 40 V 70 H-5Z" fill="rgba(var(--accent-rgb), 0.4)" />
                    <path d="M-5 70 L25 50 L50 60 L70 48 L85 58 L105 50 V 70 H-5Z" fill="rgba(var(--accent-rgb), 0.6)" />
                </g>
            </svg>
        </div>
        <h2 id="dynamic-greeting"></h2>
        <h1>Himachal Quiz Challenge</h1>
        <p style="max-width: 450px; margin: 16px auto 0;">Test your knowledge of Himachal Pradesh. Each session features a new set of 30 questions with varying difficulty.</p>
      </header>
      <div class="container-main">
        <div id="top-score-highlight"></div>
        <div id="gemini-fact-area" class="gemini-feature">
            <h3>âœ¨ Fact of the Day</h3>
            <p id="gemini-fact-text">Fetching a fun fact...</p>
        </div>
        <div id="leaderboard-area" class="leaderboard" style="margin-top: 16px;"></div>
      </div>
      <footer class="container-footer">
        <button id="start-btn" class="main-btn">Start Challenge</button>
        <div class="welcome-options">
          <a href="#" id="study-guide-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            <span>Study</span>
          </a>
          <a href="#" id="about-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <span>About</span>
          </a>
          <a href="#" id="settings-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span>Settings</span>
          </a>
        </div>
      </footer>
     </div>
    </div>
  </main>

  <main id="quiz-screen" class="screen">
    <div class="container">
     <div class="scrollable-content">
      <header class="container-header">
        <div class="quiz-top-bar">
          <span id="round-title">Round 1</span>
          <span id="streak-counter">ðŸ”¥ 0</span>
        </div>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
      </header>
      <div id="question-content">
        <p class="question" id="question">Loading question...</p>
        <div class="options" id="options"></div>
      </div>
      <footer class="container-footer">
        <div id="feedback-area" role="alert" aria-live="assertive"></div>
        <div id="timer-bar-container"><div id="timer-bar"></div></div>
        <div class="powerup-container">
            <button id="powerup-5050-btn" class="secondary-btn">âœ¨ 50/50</button>
            <button id="hint-btn" class="secondary-btn">âœ¨ Hint</button>
        </div>
        <button id="next-btn" class="main-btn" style="display: none;">Next</button>
      </footer>
     </div>
    </div>
  </main>

  <main id="results-screen" class="screen">
    <div class="container">
      <div class="scrollable-content">
      <header class="container-header">
        <div class="medal-display"></div>
        <h1 id="final-badge"></h1>
      </header>
      <div class="container-main">
        <div id="score-display-area"></div>
        <div id="save-score-container"></div>
        <div id="results-leaderboard-area" class="leaderboard"></div>
      </div>
      <footer class="container-footer">
        <div id="results-buttons-area" class="results-buttons"></div>
      </footer>
      </div>
    </div>
  </main>

  <div id="modal-overlay">
    <div id="modal-content" class="container"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const QUIZ_VERSION = '34.0';
        const ADMIN_PASSWORD = 'hianime.2810@gmail.com';
        const TOTAL_QUESTIONS = 31;
        const NORMAL_QUESTIONS = [
            { question: "Which fruit is Himachal Pradesh famous for?", options: ["Mango","Apple","Banana","Guava"], answer: "Apple" },
            { question: "What is the traditional Himachali cap called?", options: ["Topi","Pagdi","Kullu Cap","Turban"], answer: "Kullu Cap" },
            { question: "Which river flows through Kangra valley?", options: ["Beas","Sutlej","Ravi","Chenab"], answer: "Beas" },
            { question: "What is the major cash crop of Kinnaur district?", options: ["Rice","Apple","Wheat","Maize"], answer: "Apple" },
            { question: "Shimla was the summer capital of which era?", options: ["British Raj","Mughal Empire","Maurya Empire","Gupta Empire"], answer: "British Raj" },
            { question: "Which Himachali festival is celebrated with dances like Nati?", options: ["Diwali","Holi","Kullu Dussehra","Baisakhi"], answer: "Kullu Dussehra" },
            { question: "Manali is located in which district?", options: ["Kullu","Solan","Mandi","Chamba"], answer: "Kullu" },
            { question: "Which is a famous hot spring in Himachal Pradesh?", options: ["Manikaran","Dalhousie","Chail","Kasol"], answer: "Manikaran" },
            { question: "The Great Himalayan National Park is in which district?", options: ["Kullu","Lahaul","Spiti","Solan"], answer: "Kullu" },
            { question: "What is a traditional dance of Kullu Valley?", options: ["Bhangra","Nati","Garba","Dandiya"], answer: "Nati" },
            { question: "Which town is famous for Tibetan monasteries?", options: ["Dharamshala","Solan","Chamba","Mandi"], answer: "Dharamshala" },
            { question: "Which type of apples is widely grown in Himachal?", options: ["Red Delicious","Golden","Granny Smith","Fuji"], answer: "Red Delicious" },
            { question: "Which fort is a landmark of Kangra?", options: ["Kangra Fort","Naggar Fort","Chamba Fort","Bharmour Fort"], answer: "Kangra Fort" },
            { question: "What is a popular Himachali cuisine?", options: ["Sidu","Rogan Josh","Pani Puri","Dosa"], answer: "Sidu" },
            { question: "Which wildlife sanctuary is in Solan district?", options: ["Chail Sanctuary","Pin Valley","Great Himalayan","Simbalbara"], answer: "Chail Sanctuary" },
            { question: "Which lake is also known as 'Mini Switzerland of India'?", options: ["Chamera","Khajjiar","Dal Lake","Rewalsar"], answer: "Khajjiar" },
            { question: "Which town is a base for Rohtang Pass?", options: ["Manali","Shimla","Kullu","Mandi"], answer: "Manali" },
            { question: "Which Himachali tribe is known for woolen crafts?", options: ["Gaddi","Bhutia","Lohar","Pahari"], answer: "Gaddi" },
            { question: "The Kalka-Shimla Railway is a UNESCO what?", options: ["World Heritage Site","National Park","Biosphere Reserve","Geopark"], answer: "World Heritage Site" },
            { question: "Which temple is famous in Mandi?", options: ["Bhootnath Temple","Bhimakali Temple","Triloknath Temple","Hidimba Devi Temple"], answer: "Bhootnath Temple" },
            { question: "What is the traditional craft of Chamba, famous for its intricate embroidery?", options: ["Thangka Painting","Chamba Rumal","Kullu Shawl","Kangra Miniature"], answer: "Chamba Rumal" },
            { question: "Which mountain range predominantly runs through Himachal?", options: ["Aravalli","Himalayas","Vindhya","Sahyadri"], answer: "Himalayas" },
            { question: "What is the state animal of Himachal Pradesh?", options: ["Musk Deer", "Snow Leopard", "Himalayan Tahr", "Black Bear"], answer: "Snow Leopard" },
            { question: "Which town hosts the famous Kullu Dussehra festival?", options: ["Kullu","Manali","Shimla","Mandi"], answer: "Kullu" },
            { question: "The ancient Tabo Monastery, a UNESCO site, is located in which valley?", options: ["Kullu Valley", "Kangra Valley", "Spiti Valley", "Parvati Valley"], answer: "Spiti Valley"},
            { question: "Which river is a major tributary of Sutlej, originating from the Spiti valley?", options: ["Beas","Chenab","Spiti","Ravi"], answer: "Spiti" },
            { question: "The Christ Church, a prominent landmark, is located in which hill station?", options: ["Dalhousie","Kasauli","Shimla","Manali"], answer: "Shimla" },
            { question: "What is the staple food in Lahaul Valley, often used to make 'tsampa'?", options: ["Rice","Barley","Maize","Wheat"], answer: "Barley" },
            { question: "Which pass connects Kullu Valley with Lahaul and Spiti Valleys?", options: ["Rohtang Pass", "Bara-lacha la Pass", "Shipki La Pass", "Sach Pass"], answer: "Rohtang Pass" },
            { question: "Which town is famous for its intricate woolen shawls?", options: ["Kullu","Solan","Chamba","Dharamshala"], answer: "Kullu" }
        ];
        const HARD_QUESTIONS = [
            { question: "Modern activism around the River Beas has focused on?", options: ["Overfishing","Illegal sand mining and hydropower impacts","Lack of boat traffic","Seasonal flooding"], answer: "Illegal sand mining and hydropower impacts", isHard: true },
            { question: "How has the gig economy changed youth employment in towns?", options: ["Offers lifetime job security","Long-term contracts","Flexible task-based work like delivery services","Exclusive artisan jobs"], answer: "Flexible task-based work like delivery services", isHard: true },
            { question: "Which renewable energy sources are being significantly expanded in Himachal?", options: ["Coal & Geothermal","Solar & Hydropower","Petroleum & Wind","Nuclear & Tidal"], answer: "Solar & Hydropower", isHard: true },
            { question: "What modern technology helps farmers in Himachal better track crop health and soil moisture?", options: ["Radio broadcasts","Mobile apps & IoT sensors","Town criers","Printed manuals"], answer: "Mobile apps & IoT sensors", isHard: true },
            { question: "The growth of tourism most commonly impacts fragile Himalayan regions by causing:", options: ["Population decline","Increased plastic waste & pollution","Forest expansion","No significant effect"], answer: "Increased plastic waste & pollution", isHard: true },
            { question: "Himachali artisans increasingly reach global markets primarily through:", options: ["Local fairs only","E-commerce platforms & international exhibitions","Street stalls in major cities only","Government-run stalls only"], answer: "E-commerce platforms & international exhibitions", isHard: true },
            { question: "A major climate change impact observed in the Himachal Himalayas is:", options: ["Consistent increase in snowfall","Erratic weather patterns and glacial retreat","Higher crop yields everywhere","Stable year-round temperatures"], answer: "Erratic weather patterns and glacial retreat", isHard: true },
            { question: "The Atal Tunnel, a modern engineering marvel, primarily reduces:", options: ["Air pollution","The need for tourism","Distance & winter travel time to Lahaul","Scenery on the drive"], answer: "Distance & winter travel time to Lahaul", isHard: true },
            { question: "What modern medium is crucial for preserving and promoting Himachali folk music and culture today?", options: ["Internet platforms & digital media","Complete cultural isolation","Strictly oral tradition","Government archives only"], answer: "Internet platforms & digital media", isHard: true },
            { question: "'Smart villages' initiatives in Himachal Pradesh primarily focus on improving:", options: ["Only traditional farming methods","Digital infrastructure, e-governance, and services","Manual labor opportunities","Isolation from urban centers"], answer: "Digital infrastructure, e-governance, and services", isHard: true },
             { question: "What is a key focus of the 'Natural Farming Khushhal Kisan Yojana' scheme in Himachal?", options: ["Promoting use of chemical fertilizers", "Reducing dependence on chemicals", "Exclusively growing cash crops", "Mechanizing all farms"], answer: "Reducing dependence on chemicals", isHard: true },
            { question: "The 'Himachal Pradesh State Data Centre' is a modern initiative for what purpose?", options: ["Storing historical photos", "Centralizing e-governance applications", "Tracking tourist movements", "Broadcasting radio signals"], answer: "Centralizing e-governance applications", isHard: true }
        ];

        // --- DOM ELEMENT CACHE ---
        const elements = {
            screens: {
                welcome: document.getElementById('welcome-screen'),
                quiz: document.getElementById('quiz-screen'),
                results: document.getElementById('results-screen')
            },
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            aboutBtn: document.getElementById('about-btn'),
            studyGuideBtn: document.getElementById('study-guide-btn'),
            hintBtn: document.getElementById('hint-btn'),
            powerup5050Btn: document.getElementById('powerup-5050-btn'),
            leaderboardArea: document.getElementById('leaderboard-area'),
            topScoreHighlight: document.getElementById('top-score-highlight'),
            roundTitle: document.getElementById('round-title'),
            streakCounter: document.getElementById('streak-counter'),
            progressBar: document.getElementById('progress-bar'),
            question: document.getElementById('question'),
            options: document.getElementById('options'),
            feedbackArea: document.getElementById('feedback-area'),
            timerBarContainer: document.getElementById('timer-bar-container'),
            timerBar: document.getElementById('timer-bar'),
            medalDisplay: document.getElementById('results-screen').querySelector('.medal-display'),
            finalBadge: document.getElementById('final-badge'),
            scoreDisplayArea: document.getElementById('score-display-area'),
            saveScoreContainer: document.getElementById('save-score-container'),
            resultsLeaderboardArea: document.getElementById('results-leaderboard-area'),
            resultsButtonsArea: document.getElementById('results-buttons-area'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            geminiFactText: document.getElementById('gemini-fact-text'),
            toast: document.getElementById('toast'),
            mascot: {
                container: document.getElementById('mascot'),
                message: document.getElementById('mascot-message'),
                mouth: document.getElementById('mouth'),
            },
            body: document.body,
            aurora: document.querySelector('.background-aurora'),
            docElement: document.documentElement
        };

        // --- STATE & HELPERS ---
        let state = {};
        let activeModalClose = null;
        let sounds = {};
        const shuffleArray = (arr) => [...arr].sort(() => 0.5 - Math.random());
        
        // --- SOUND SETUP ---
        function setupSounds() {
            try {
                sounds.click = new Tone.PluckSynth({attackNoise: 0.1, dampening: 4000, resonance: 0.7}).toDestination();
                sounds.click.volume.value = -10;

                sounds.correct = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.2 }
                }).toDestination();
                sounds.correct.volume.value = -12;

                sounds.incorrect = new Tone.FMSynth({
                     harmonicity: 1.2,
                     modulationIndex: 5,
                     envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.5 },
                     modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
                }).toDestination();
                sounds.incorrect.volume.value = -15;
            } catch (e) {
                console.warn("Could not initialize audio context.", e);
            }
        }

        function playSound(sound, note) {
            if (state.settings.soundEnabled && sounds[sound] && Tone.context.state === 'running') {
                 if(sound === 'click'){
                    sounds.click.triggerAttack("G4", Tone.now());
                } else if (sound === 'correct') {
                    sounds.correct.triggerAttackRelease(["C5", "G5"], "16n", Tone.now());
                }
                else {
                    sounds.incorrect.triggerAttackRelease("F#3", "8n");
                }
            }
        }
        
        // --- GEMINI API ---
        async function callGemini(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                 if (text) {
                    text = text.replace(/^```(json|)\s*/, '').replace(/```$/, '');
                    return text.trim();
                } else {
                    throw new Error("Invalid response structure.");
                }
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGemini(prompt, retries - 1, delay * 2);
                }
                console.error("Gemini API call failed:", error);
                return null;
            }
        }

        async function fetchFactOfTheDay() {
            const prompt = "Tell me a single, interesting, and concise fun fact about Himachal Pradesh, India. Keep it under 200 characters.";
            const fact = await callGemini(prompt);
            if(elements.geminiFactText) {
                elements.geminiFactText.textContent = fact || "Could not load a fact right now.";
            }
        }
        
        async function getExplanation(question, correctAnswer) {
            const prompt = `For the quiz question "${question}", why is the correct answer "${correctAnswer}"? Provide a very brief, one-sentence explanation.`;
            showModal(`<h2>âœ¨ Explanation</h2><div class="scrollable-content"><p>Thinking...</p></div>`);
            const explanation = await callGemini(prompt);
            showModal(`<h2>âœ¨ Explanation</h2><div class="scrollable-content"><p>${explanation || "Sorry, I couldn't get an explanation."}</p></div>`);
        }
        
        async function getHint() {
            const prompt = `Give me a short, one-sentence hint for the following quiz question, but do NOT give the answer. Question: "${state.gameQuestions[state.questionIndex].question}" The correct answer is ${state.gameQuestions[state.questionIndex].answer}.`;
            showAlert(`<h2>âœ¨ Hint</h2><p>Thinking...</p>`);
            const hint = await callGemini(prompt);
            showAlert(`<h2>âœ¨ Hint</h2><p>${hint || "Sorry, I couldn't get a hint."}</p>`);
        }

        async function useFiftyFifty() {
            state.powerupUsed = true;
            elements.powerup5050Btn.disabled = true;
            elements.powerup5050Btn.classList.add('faded');
            
            const currentQuestion = state.gameQuestions[state.questionIndex];
            const options = Array.from(elements.options.children);
            const incorrectOptions = options.filter(opt => opt.textContent !== currentQuestion.answer);
            
            shuffleArray(incorrectOptions).slice(0, 2).forEach(btn => {
                btn.classList.add('faded');
                btn.disabled = true;
            });
        }

        async function showStudyGuide() {
            showModal(`<h2>ðŸ“š Study Guide</h2><div class="scrollable-content"><p>Generating a quick study guide...</p></div>`);
            const prompt = "Provide 5 interesting facts about Himachal Pradesh for a study guide. Each fact MUST start with a relevant emoji, followed by a space, then the fact text. Use a newline for each fact.";
            const guideText = await callGemini(prompt);
            if (guideText) {
                const facts = guideText.split('\n').filter(fact => fact.trim() !== '');
                const listHTML = facts.map((fact, index) => {
                    const match = fact.match(/^(\p{Emoji_Presentation}|\p{Emoji}) (.*)/u);
                    if (match) {
                        return `<li style="animation-delay: ${index * 100}ms"><span>${match[1]}</span>${match[2]}</li>`;
                    }
                    return `<li style="animation-delay: ${index * 100}ms">${fact}</li>`;
                }).join('');
                showModal(`<h2>ðŸ“š Study Guide</h2><div class="scrollable-content"><div class="study-guide"><ul>${listHTML}</ul></div></div>`);
            } else {
                 showModal(`<h2>ðŸ“š Study Guide</h2><div class="scrollable-content"><div class="study-guide"><p>Could not load the study guide right now.</p></div></div>`);
            }
        }

        async function analyzePerformance() {
            playSound('click');
            const incorrectAnswers = state.userAnswers.filter(a => a.userAnswer !== a.correctAnswer);

            if (incorrectAnswers.length === 0) {
                showModal(`<h2>âœ¨ Performance Analysis</h2><div class="scrollable-content"><p>Wow, a perfect score! You have an excellent knowledge of Himachal Pradesh. Keep up the fantastic work!</p></div>`);
                return;
            }

            showModal(`<h2>âœ¨ Performance Analysis</h2><div class="scrollable-content"><p>Analyzing your results...</p></div>`);

            const questionsForPrompt = incorrectAnswers.map(item => `- Question: "${item.question}" (Correct Answer: ${item.correctAnswer})`).join('\n');
            
            const prompt = `A user took a quiz about Himachal Pradesh. Here are the questions they got wrong:\n${questionsForPrompt}\n\nBased on these mistakes, what topics should they study more? Provide a brief, encouraging, one-paragraph analysis of their performance and then list 2-3 specific topics to focus on as a bulleted list.`;

            const analysis = await callGemini(prompt);

            let finalHTML = "Sorry, I couldn't generate an analysis at this time. Please try again later.";
            if (analysis) {
                const parts = analysis.split('\n').filter(p => p.trim() !== '');
                const paragraph = `<p>${parts[0]}</p>`;
                const listItems = parts.slice(1).map(item => `<li>${item.replace(/^- |^\* /, '')}</li>`).join('');
                finalHTML = `${paragraph}<ul>${listItems}</ul>`;
            }

            showModal(`<h2>âœ¨ Performance Analysis</h2><div class="scrollable-content"><div class="study-guide">${finalHTML}</div></div>`);
        }

        async function handleTellMeMore(event) {
            const btn = event.currentTarget;
            playSound('click');
            btn.disabled = true;
            btn.textContent = 'Thinking...';

            const question = decodeURIComponent(btn.dataset.question);
            const answer = decodeURIComponent(btn.dataset.answer);
            const targetId = btn.dataset.targetId;
            const targetElement = document.getElementById(targetId)?.querySelector('.more-info-content');

            if (!targetElement) return;

            const prompt = `A user is reviewing their quiz answers. For the topic related to the question "${question}" (where the correct answer is "${answer}"), provide an interesting paragraph (about 2-3 sentences) with more details. Focus on providing extra context or a fun fact. Do not repeat the question or the answer.`;
            
            const moreInfo = await callGemini(prompt);
            
            targetElement.style.display = 'block'; // Make the container visible

            if (moreInfo) {
                targetElement.innerHTML = `<p>${moreInfo}</p>`;
            } else {
                targetElement.innerHTML = `<p>Sorry, couldn't fetch more details right now.</p>`;
            }

            btn.style.display = 'none'; // Hide button after use
        }

        // --- UI & FEEDBACK ---
        function updateStreakCounter() {
            elements.streakCounter.textContent = `ðŸ”¥ ${state.currentStreak}`;
            elements.streakCounter.classList.toggle('visible', state.currentStreak > 1);
        }

        function flashAurora(isCorrect) {
            if (!elements.aurora || state.settings.reduceMotion) return;
            elements.aurora.className = 'background-aurora';
            void elements.aurora.offsetWidth;
            elements.aurora.classList.add(isCorrect ? 'aurora-flash-correct' : 'aurora-flash-incorrect');
        }
        
        function showToast(message, type) {
            if (state.settings.reduceMotion) return;
            elements.toast.textContent = message;
            elements.toast.className = type;
            elements.toast.classList.add('show');
            if(type === 'streak' && typeof confetti === 'function'){
                 confetti({ particleCount: 50, spread: 40, origin: { y: 0.6 }, colors: ['#ffc900', '#ff9500'] });
            }
             if(type === 'perfect' && typeof confetti === 'function'){
                 confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }, colors: ['#00f2fe', '#f5f5f7'] });
            }
            setTimeout(() => elements.toast.classList.remove('show'), 2500);
        }

        function switchScreen(screenId) {
            const transitionDuration = 300; 
            const interactivityDelay = transitionDuration + 50;

            Object.values(elements.screens).forEach(screen => {
                screen.classList.remove('show');
                screen.style.pointerEvents = 'none';
            });

            const targetScreen = elements.screens[screenId];
            if (targetScreen) {
                targetScreen.classList.add('show');
                setTimeout(() => {
                    if (targetScreen.classList.contains('show')) {
                        targetScreen.style.pointerEvents = 'auto';
                    }
                }, interactivityDelay);
            }
        }
        
        let mascotTimeout;
        function showMascot(isCorrect, message) {
            if(state.settings.reduceMotion) return;
            clearTimeout(mascotTimeout);
            const messages = isCorrect 
                ? ["Great job!", "Awesome!", "You got it!", "Correct!", "Brilliant!"] 
                : ["Almost!", "So close!", "Keep trying!", "Not quite!", "You can do it!"];
            
            elements.mascot.message.textContent = message || messages[Math.floor(Math.random() * messages.length)];
            
            elements.mascot.container.style.animation = 'none';
            void elements.mascot.container.offsetWidth;
            elements.mascot.container.style.animation = '';
            
            elements.mascot.container.classList.add('show');
            
            if (isCorrect) {
                 elements.mascot.mouth.setAttribute('d', 'M48 35 C 49 36, 51 36, 52 35');
            } else {
                 elements.mascot.mouth.setAttribute('d', 'M48 36 C 49 35, 51 35, 52 36');
            }

            setTimeout(() => elements.mascot.container.classList.add('show-message'), 100);

            mascotTimeout = setTimeout(() => {
                elements.mascot.container.classList.remove('show-message');
                setTimeout(() => {
                    elements.mascot.container.classList.remove('show');
                }, 800);
            }, 3000);
        }

        function showWelcomeMascot() {
            if (state.settings.reduceMotion) return;
            const welcomeMessages = ["Ready for a challenge?", "Welcome! Let's play!", "Hello! Let's begin.", "Time for a quiz!"];
            clearTimeout(mascotTimeout); 
            elements.mascot.container.style.animation = '';
            elements.mascot.message.textContent = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            elements.mascot.mouth.setAttribute('d', 'M48 35 C 49 36, 51 36, 52 35');
            elements.mascot.container.classList.add('show', 'waving');
            setTimeout(() => {
                elements.mascot.container.classList.add('show-message');
            }, 800);

            mascotTimeout = setTimeout(() => {
                elements.mascot.container.classList.remove('show-message');
            }, 5000);
        }
        
        function getRoundTitle(index) {
            if (index < 10) return "Round 1 & 2";
            if (index < 15) return "Hard Round 1";
            if (index < 25) return "Round 3 & 4";
            return "Hard Round 2";
        }


        // --- CORE GAME LOGIC ---
        function initializeState() {
            let settings = { largeText: false, theme: 'auto', reduceMotion: false, soundEnabled: true };
            try {
                const saved = localStorage.getItem('quizSettings');
                if (saved) settings = { ...settings, ...JSON.parse(saved) };
            } catch (e) { console.error("Could not parse settings", e); }
            
            state = {
                questionIndex: -1, 
                gameQuestions: [],
                correctAnswers: 0,
                score: 0,
                currentStreak: 0,
                mistakesThisRound: 0,
                questionTimer: null,
                userAnswers: [],
                settings: settings,
                powerupUsed: false
            };
            
            elements.progressBar.style.width = '0%';
            updateStreakCounter();
            clearInterval(state.questionTimer);
        }

        async function startGame() {
            clearTimeout(mascotTimeout);
            elements.mascot.container.classList.remove('show', 'show-message', 'waving');
            
            initializeState();
            prepareQuestions();
            applySettings();
            switchScreen('quiz');
            
            const startMessages = ["Let's do this!", "Good luck!", "Here we go!", "The challenge begins!"];
            showMascot(true, startMessages[Math.floor(Math.random() * startMessages.length)]);
            await new Promise(res => setTimeout(res, 2000));
            loadNextQuestion();
        }
        
        function setDynamicGreeting() {
            const hour = new Date().getHours();
            let greeting, timeOfDay;

            if (hour >= 5 && hour < 12) {
                greeting = "Good Morning!";
                timeOfDay = 'morning';
            } else if (hour >= 12 && hour < 18) {
                greeting = "Good Afternoon!";
                timeOfDay = 'afternoon';
            } else if (hour >= 18 && hour < 21) {
                greeting = "Good Evening!";
                timeOfDay = 'evening';
            } else {
                greeting = "Good Night!";
                timeOfDay = 'night';
            }
            
            const greetingEl = document.getElementById('dynamic-greeting');
            if (greetingEl) {
                greetingEl.textContent = greeting;
            }
            updateHeroImage(timeOfDay);
        }

        function updateHeroImage(timeOfDay) {
            const sunMoon = document.getElementById('sun-moon');
            const stars = document.getElementById('stars');
            const skyStop1 = document.getElementById('skyStop1');
            const skyStop2 = document.getElementById('skyStop2');
            
            if (!sunMoon || !stars || !skyStop1 || !skyStop2) return;

            stars.style.opacity = '0';

            switch(timeOfDay) {
                case 'morning':
                    skyStop1.setAttribute('stop-color', '#87CEEB');
                    skyStop2.setAttribute('stop-color', '#f0e68c');
                    sunMoon.setAttribute('cy', '35');
                    sunMoon.setAttribute('fill', '#FFD700');
                    break;
                case 'afternoon':
                    skyStop1.setAttribute('stop-color', '#007aff');
                    skyStop2.setAttribute('stop-color', '#87CEEB');
                    sunMoon.setAttribute('cy', '20');
                    sunMoon.setAttribute('fill', '#FFFF00');
                    break;
                case 'evening':
                    skyStop1.setAttribute('stop-color', '#483D8B');
                    skyStop2.setAttribute('stop-color', '#FF6347');
                    sunMoon.setAttribute('cy', '40');
                    sunMoon.setAttribute('fill', '#FFA500');
                    break;
                case 'night':
                    skyStop1.setAttribute('stop-color', '#000033');
                    skyStop2.setAttribute('stop-color', '#1c1d23');
                    sunMoon.setAttribute('cy', '25');
                    sunMoon.setAttribute('fill', '#F5F5F7');
                    stars.style.opacity = '1';
                    break;
            }
        }

        function goHome() {
            switchScreen('welcome');
            initializeState();
            applySettings();
            displayLeaderboard(elements.leaderboardArea, true);
            showWelcomeMascot();
            setDynamicGreeting();
            if(elements.geminiFactText) {
                elements.geminiFactText.textContent = "Fetching a new fun fact...";
            }
            fetchFactOfTheDay();
        }

        function prepareQuestions() {
            const sessionNormal = shuffleArray(NORMAL_QUESTIONS);
            const sessionHard = shuffleArray(HARD_QUESTIONS);
            state.gameQuestions = [
                ...sessionNormal.slice(0, 10),
                ...sessionHard.slice(0, 5),
                ...sessionNormal.slice(10, 20),
                ...sessionHard.slice(5, 10)
            ];
            const geminiQIndex = Math.floor(Math.random() * 20) + 5;
            state.gameQuestions.splice(geminiQIndex, 0, { type: 'gemini_place' });
        }
        
        function loadNextQuestion() {
            const roundBoundaries = { 9: 10, 14: 5, 24: 10, 29: 5 }; 
            if (roundBoundaries[state.questionIndex] && state.mistakesThisRound === 0 && state.questionIndex !== -1) {
                state.score += 50;
                showToast("ðŸ† Perfect Round! +50 Points", "perfect");
            }
            if (roundBoundaries[state.questionIndex]) {
                state.mistakesThisRound = 0; 
            }

            elements.nextBtn.style.display = 'none';
            elements.hintBtn.style.display = 'none';
            elements.powerup5050Btn.style.display = 'none';
            if(!state.powerupUsed) {
                elements.powerup5050Btn.style.display = 'none';
                elements.powerup5050Btn.disabled = false;
            }

            state.questionIndex++;

            if (state.questionIndex >= TOTAL_QUESTIONS) {
                showResults();
                return;
            }
            
            const q = state.gameQuestions[state.questionIndex];
            if (q.type === 'gemini_place') {
                generateGeminiQuestion();
            } else {
                displayQuestion(q);
            }
        }
        
        async function generateGeminiQuestion() {
            elements.question.textContent = "Generating a special question...";
            elements.options.innerHTML = "";

            const prompt = `Create a "Guess the Place" quiz question about a famous location in Himachal Pradesh. Provide a descriptive paragraph (2-3 sentences) and four options: one correct answer and three plausible but incorrect alternative locations from Himachal. Format the output as a JSON object with keys: "question", "options", "answer".`;
            
            const result = await callGemini(prompt);
            try {
                const newQ = JSON.parse(result);
                newQ.isHard = true; 
                state.gameQuestions[state.questionIndex] = newQ;
                displayQuestion(newQ);
            } catch (e) {
                console.error("Failed to parse Gemini question, loading a backup:", e);
                state.gameQuestions[state.questionIndex] = shuffleArray(HARD_QUESTIONS)[0];
                displayQuestion(state.gameQuestions[state.questionIndex]);
            }
        }

        function displayQuestion(q) {
            if (!q) { showResults(); return; }

            elements.feedbackArea.className = '';
            elements.feedbackArea.innerHTML = '';
            
            if (!state.settings.reduceMotion) {
                elements.question.style.animation = 'none';
                void elements.question.offsetWidth;
                elements.question.style.animation = 'question-fade-in 0.5s ease';
            }
            
            elements.progressBar.style.width = `${((state.questionIndex + 1) / TOTAL_QUESTIONS) * 100}%`;
            elements.roundTitle.textContent = `${getRoundTitle(state.questionIndex)} (${state.questionIndex + 1}/${TOTAL_QUESTIONS})`;
            elements.question.textContent = q.question;
            elements.options.innerHTML = "";
            
            const shuffledOptions = shuffleArray(q.options);
            state.gameQuestions[state.questionIndex].shuffledOptions = shuffledOptions; 
            
            shuffledOptions.forEach(opt => {
                const btn = document.createElement("button");
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(opt, q);
                elements.options.appendChild(btn);
            });
            
            setTimeout(() => {
                elements.hintBtn.style.display = 'inline-flex';
                if(!state.powerupUsed) elements.powerup5050Btn.style.display = 'inline-flex';
            }, 3000);
            
            clearInterval(state.questionTimer);
            if (q.isHard) {
                elements.timerBarContainer.style.display = 'block';
                elements.timerBar.style.transition = 'none';
                elements.timerBar.style.width = '100%';
                void elements.timerBar.offsetWidth;
                elements.timerBar.style.transition = `width 15s linear`;
                elements.timerBar.style.width = '0%';
                state.questionTimer = setTimeout(() => checkAnswer(null, q, true), 15000);
            } else {
                elements.timerBarContainer.style.display = 'none';
            }
        }

        function checkAnswer(selectedOption, q, timedOut = false) {
            clearTimeout(state.questionTimer);
            
            const isCorrect = selectedOption === q.answer;
            showMascot(isCorrect);
            playSound(isCorrect ? 'correct' : 'incorrect');

            state.userAnswers.push({
                question: q.question, 
                options: state.gameQuestions[state.questionIndex].shuffledOptions,
                correctAnswer: q.answer, 
                userAnswer: selectedOption
            });

            Array.from(elements.options.children).forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === q.answer) btn.classList.add('correct');
                else if (btn.textContent === selectedOption) btn.classList.add('incorrect');
                btn.classList.add('answered');
            });

            elements.feedbackArea.innerHTML = '';
            elements.hintBtn.style.display = 'none';
            elements.powerup5050Btn.style.display = 'none';

            if (isCorrect) {
                state.currentStreak++; 
                state.correctAnswers++; 
                state.score += 10;
                elements.feedbackArea.innerHTML = `<span>Correct! +10 Points</span>`;
                elements.feedbackArea.className = 'correct visible';
                flashAurora(true);

                if(state.currentStreak > 0 && state.currentStreak % 5 === 0) {
                    state.score += 25;
                    showToast("ðŸ”¥ Streak Bonus! +25 Points", "streak");
                }

            } else {
                state.currentStreak = 0; 
                state.mistakesThisRound++;
                state.score = Math.max(0, state.score - 5);
                const feedbackText = timedOut ? "Time's Up! -5 Points" : "Incorrect! -5 Points";
                
                const textSpan = document.createElement('span');
                textSpan.textContent = feedbackText;
                elements.feedbackArea.appendChild(textSpan);
                
                const explainBtn = document.createElement('button');
                explainBtn.innerHTML = 'âœ¨ Explain';
                explainBtn.className = 'secondary-btn explain-btn';
                explainBtn.onclick = () => { playSound('click'); getExplanation(q.question, q.answer); };
                elements.feedbackArea.appendChild(explainBtn);

                elements.feedbackArea.className = 'incorrect visible';
                flashAurora(false);
            }

            updateStreakCounter();
            elements.nextBtn.style.display = 'inline-block';
            elements.nextBtn.focus();
        }

        function showResults() {
            switchScreen('results');
            
            const animatedElements = [elements.medalDisplay, elements.finalBadge, elements.scoreDisplayArea, elements.saveScoreContainer, elements.resultsLeaderboardArea, elements.resultsButtonsArea];
            animatedElements.forEach(el => el.classList.remove('animate'));

            const percentage = (state.correctAnswers / TOTAL_QUESTIONS) * 100;
            let badge, medalIcon, badgeClass;
            
            if (percentage >= 90) { badge = "Gold Medalist"; medalIcon = "ðŸ¥‡"; badgeClass = "gold"; if(!state.settings.reduceMotion && typeof confetti === 'function') setTimeout(() => confetti({ particleCount: 150, spread: 90, zIndex: 2001 }), 500); }
            else if (percentage >= 75) { badge = "Silver Medalist"; medalIcon = "ðŸ¥ˆ"; badgeClass = "silver"; }
            else if (percentage >= 60) { badge = "Bronze Medalist"; medalIcon = "ðŸ¥‰"; badgeClass = "bronze"; }
            else { badge = "Great Effort! Try Again!"; medalIcon = "ðŸ™‚"; badgeClass = ""; }
            
            elements.medalDisplay.textContent = medalIcon;
            elements.finalBadge.textContent = badge;
            elements.finalBadge.className = badgeClass;
            
            const finalScoreEl = document.createElement('span');
            finalScoreEl.id = 'final-score-value';
            finalScoreEl.className = 'score-value final';
            finalScoreEl.textContent = '0';

            elements.scoreDisplayArea.innerHTML = `<div class="score-breakdown"><div>Final Score <span id="final-score-container"></span></div><div>Correct Answers <span class="score-value">${state.correctAnswers} / ${TOTAL_QUESTIONS} (${percentage.toFixed(0)}%)</span></div></div>`;
            document.getElementById('final-score-container').appendChild(finalScoreEl);

            elements.saveScoreContainer.innerHTML = `<div id="save-score-area"><input type="text" id="player-name" placeholder="Enter your name" maxlength="15"><button id="save-score-btn">Save Score</button></div>`;
            
            document.getElementById('save-score-btn').onclick = () => { playSound('click'); saveScoreAction(state.score); };
            
            elements.resultsButtonsArea.innerHTML = `
                <div style="grid-column: span 2; margin-bottom: 12px;">
                    <button id="analyze-performance-btn" class="main-btn">âœ¨ Analyze My Performance</button>
                </div>
                <button id="review-answers-btn" class="secondary-btn">Review Answers</button>
                <button id="go-home-btn-results" class="main-btn">Go Home</button>
            `;
            document.getElementById('analyze-performance-btn').onclick = () => { playSound('click'); analyzePerformance(); };
            document.getElementById('go-home-btn-results').onclick = () => { playSound('click'); goHome(); };
            document.getElementById('review-answers-btn').onclick = () => { playSound('click'); showReviewModal(); };

            displayLeaderboard(elements.resultsLeaderboardArea, false);

            setTimeout(() => {
                animatedElements.forEach(el => el.classList.add('animate'));
                animateScore(state.score, finalScoreEl);
            }, 100);
        }
        
        function animateScore(targetScore, element) {
            let currentScore = 0;
            const duration = 1000;
            const stepTime = Math.max(10, Math.abs(Math.floor(duration / (targetScore || 1))));
            
            const timer = setInterval(() => {
                if (currentScore < targetScore) {
                    currentScore++;
                } else if (currentScore > targetScore) {
                    currentScore--;
                } else {
                    clearInterval(timer);
                    return;
                }
                element.textContent = currentScore;
            }, stepTime);
        }

        // --- MODAL & SETTINGS ---
        function showModal(contentHTML) {
            if (activeModalClose) activeModalClose(true);
            elements.docElement.classList.add('modal-open');
            elements.modalContent.innerHTML = `<button class="modal-close-btn" aria-label="Close modal">&times;</button>${contentHTML}`;
            elements.modalOverlay.classList.add('show');
            
            const closeModal = (silent = false) => {
                elements.docElement.classList.remove('modal-open');
                elements.modalOverlay.classList.remove('show'); 
                document.removeEventListener('keydown', keydownHandler);
                activeModalClose = null;
            };
            
            const keydownHandler = (e) => { if (e.key === 'Escape') closeModal(); };
            activeModalClose = closeModal;
            document.addEventListener('keydown', keydownHandler);
            elements.modalContent.querySelector('.modal-close-btn').onclick = () => { playSound('click'); closeModal(); };
        }
        
        function showAlert(messageHTML) {
            return new Promise(resolve => {
                showModal(`${messageHTML}<div class="modal-buttons"><button id="alert-ok-btn" class="main-btn">OK</button></div>`);
                document.getElementById('alert-ok-btn').onclick = () => { playSound('click'); if(activeModalClose) activeModalClose(true); resolve(); };
                document.getElementById('alert-ok-btn').focus();
            });
        }
        
        function showSettingsModal() {
            const settingsHTML = `
                <h2>Settings</h2>
                <div class="scrollable-content">
                    <div class="settings-row" data-clickable="true" id="theme-setting-row"><span>Theme</span><span id="current-theme-label" style="color: var(--text-secondary);"></span></div>
                    <div class="settings-row"><span>Sound Effects</span><label class="switch"><input type="checkbox" id="sound-toggle" ${state.settings.soundEnabled ? 'checked' : ''}><span class="slider"></span></label></div>
                    <div class="settings-row"><span>Large Text</span><label class="switch"><input type="checkbox" id="large-text-toggle" ${state.settings.largeText ? 'checked' : ''}><span class="slider"></span></label></div>
                    <div class="settings-row"><span>Reduce Motion</span><label class="switch"><input type="checkbox" id="reduce-motion-toggle" ${state.settings.reduceMotion ? 'checked' : ''}><span class="slider"></span></label></div>
                    <h3>Admin Controls</h3>
                    <div class="settings-row" data-clickable="true" id="manage-leaderboard-btn"><span>Manage Leaderboard</span></div>
                    <div class="settings-row" data-clickable="true" id="master-reset-btn"><span>Master Reset</span></div>
                </div>`;
            showModal(settingsHTML);
            
            const getEl = (id) => document.getElementById(id);
            
            getEl('current-theme-label').textContent = state.settings.theme.charAt(0).toUpperCase() + state.settings.theme.slice(1);
            getEl('theme-setting-row').onclick = () => { playSound('click'); showThemeMenu(); };
            getEl('sound-toggle').onchange = (e) => { state.settings.soundEnabled = e.target.checked; saveSettings(); playSound('click'); };
            getEl('large-text-toggle').onchange = (e) => { state.settings.largeText = e.target.checked; applySettings(); saveSettings(); playSound('click'); };
            getEl('reduce-motion-toggle').onchange = (e) => { state.settings.reduceMotion = e.target.checked; applySettings(); saveSettings(); playSound('click'); };
            getEl('manage-leaderboard-btn').onclick = () => { playSound('click'); handleManageLeaderboard(); };
            getEl('master-reset-btn').onclick = () => { playSound('click'); handleMasterReset(); };
        }

        function showThemeMenu() {
            const themeMenuHTML = `<h2>Select Theme</h2><div class="scrollable-content"><div class="settings-row" data-clickable="true" data-theme-choice="auto"><span>Auto (System)</span></div><div class="settings-row" data-clickable="true" data-theme-choice="light"><span>Light</span></div><div class="settings-row" data-clickable="true" data-theme-choice="dark"><span>Dark</span></div></div>`;
            showModal(themeMenuHTML);
            document.querySelectorAll('[data-theme-choice]').forEach(el => {
                el.onclick = () => {
                    playSound('click');
                    state.settings.theme = el.dataset.themeChoice;
                    saveSettings(); applyTheme(); if (activeModalClose) activeModalClose(true); showSettingsModal();
                }
            });
        }
        
        function saveSettings() { 
            try { localStorage.setItem('quizSettings', JSON.stringify(state.settings)); } catch (e) { console.error("Could not save settings", e); } 
        }
        
        function applySettings() {
            const settings = state.settings || { theme: 'auto', largeText: false, reduceMotion: false, soundEnabled: true };
            elements.docElement.setAttribute('data-theme', settings.theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : settings.theme);
            elements.docElement.classList.toggle('large-text', settings.largeText);
            elements.body.classList.toggle('reduce-motion', settings.reduceMotion);
        }
        
        function applyTheme() {
            const theme = state.settings.theme;
            elements.docElement.setAttribute('data-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme);
        }

        function showReviewModal() {
            let reviewHTML = '<h2>Review Your Answers</h2><div class="scrollable-content"><div class="review-list">';
            state.userAnswers.forEach((ans, index) => {
                const safeQuestion = encodeURIComponent(ans.question);
                const safeAnswer = encodeURIComponent(ans.correctAnswer);

                reviewHTML += `
                    <div class="review-question-item" id="review-item-${index}">
                        <h4>${index + 1}. ${ans.question}</h4>`;
                
                (ans.options || []).forEach(opt => {
                    let classes = 'review-option';
                    if (opt === ans.correctAnswer) classes += ' correct-answer';
                    else if (opt === ans.userAnswer) classes += ' user-incorrect';
                    reviewHTML += `<span class="${classes}">${opt}</span>`;
                });
                
                reviewHTML += `
                        <div style="text-align: right; margin-top: 12px;">
                            <button class="secondary-btn explain-btn tell-me-more-btn" data-question="${safeQuestion}" data-answer="${safeAnswer}" data-target-id="review-item-${index}">âœ¨ Tell Me More</button>
                        </div>
                        <div class="more-info-content" style="margin-top: 12px; padding: 12px; border-radius: 8px; background-color: rgba(var(--accent-rgb), 0.05); display: none; text-align: left; font-size: 0.9rem; color: var(--text-secondary);"></div>
                    </div>`;
            });
            reviewHTML += '</div></div>';
            showModal(reviewHTML);

            document.querySelectorAll('.tell-me-more-btn').forEach(btn => {
                btn.addEventListener('click', handleTellMeMore);
            });
        }

        // --- LEADERBOARD & ADMIN ---
        function displayLeaderboard(target, showTopScore) {
            if(!target) return;
            let leaderboard = [];
            try { leaderboard = JSON.parse(localStorage.getItem('himachalQuizLeaderboard')) || []; } catch(e) { 
                target.innerHTML = '<h3>Leaderboard</h3><p>Could not load scores.</p>';
                if (elements.topScoreHighlight) elements.topScoreHighlight.style.display = 'none';
                return; 
            }

            if (showTopScore && elements.topScoreHighlight) {
                if (leaderboard.length > 0) {
                    elements.topScoreHighlight.innerHTML = `<p>ðŸ† Top Score: ${leaderboard[0].name} - ${leaderboard[0].score}</p>`;
                    elements.topScoreHighlight.style.display = 'block';
                } else {
                    elements.topScoreHighlight.style.display = 'none';
                }
            }
            
            if (leaderboard.length === 0) { 
                target.innerHTML = `<h3>Leaderboard</h3><p>No scores yet. Be the first!</p>`; 
                return; 
            }

            let listHTML = '<h3>Leaderboard</h3><ol>';
            leaderboard.forEach(entry => listHTML += `<li><span>${entry.name}</span><span class="score">${entry.score}</span></li>`);
            target.innerHTML = listHTML + '</ol>';
        }

        async function saveScoreAction(score) {
            const playerNameEl = document.getElementById('player-name');
            if (!playerNameEl) return;
            const playerName = playerNameEl.value.trim();
            if (!playerName) { 
                await showAlert("<h2>Enter Name</h2><p>Please enter a name to save your score.</p>"); 
                playerNameEl.focus();
                return;
            }
            
            let leaderboard = [];
            try { leaderboard = JSON.parse(localStorage.getItem('himachalQuizLeaderboard')) || []; } catch(e) { console.error("Leaderboard parse error", e); }
            
            leaderboard.push({ name: playerName, score: score });
            leaderboard.sort((a, b) => b.score - a.score);
            
            try {
                localStorage.setItem('himachalQuizLeaderboard', JSON.stringify(leaderboard.slice(0, 5)));
                elements.saveScoreContainer.innerHTML = `<p style="color: var(--glow-correct); font-weight: 600;">Score Saved!</p>`;
                displayLeaderboard(elements.resultsLeaderboardArea, false);
                displayLeaderboard(elements.leaderboardArea, true);
            } catch(e) { 
                elements.saveScoreContainer.innerHTML = `<p style="color: var(--glow-incorrect);">Could not save score.</p>`;
                console.error("Could not save score", e);
            }
        }
        
        function promptForAdminPassword() {
            return new Promise(resolve => {
                showModal(`<h2>Admin Access</h2><div class="scrollable-content"><p>Please enter the password.</p><input type="password" id="admin-password-input" class="modal-input" autocomplete="current-password"><div id="modal-validation-message"></div><div class="modal-buttons"><button id="admin-submit-btn" class="main-btn">Submit</button></div></div>`);
                const input = document.getElementById('admin-password-input');
                input.focus();
                const handleSubmit = () => {
                    playSound('click');
                    if (input.value === ADMIN_PASSWORD) { if (activeModalClose) activeModalClose(true); resolve(true); } 
                    else { document.getElementById('modal-validation-message').textContent = 'Incorrect Password.'; input.value = ''; input.focus(); }
                };
                input.onkeydown = e => { if (e.key === 'Enter') handleSubmit(); };
                document.getElementById('admin-submit-btn').onclick = handleSubmit;
            });
        }
        
        function showConfirmation(message) {
          return new Promise(resolve => {
              showModal(`<h2>Are you sure?</h2><div class="scrollable-content"><p>${message}</p><div class="modal-buttons"><button id="confirm-yes-btn" class="danger-btn">Yes, I'm sure</button><button id="confirm-no-btn" class="secondary-btn">Cancel</button></div></div>`);
              document.getElementById('confirm-yes-btn').onclick = () => { playSound('click', 'C3'); if(activeModalClose) activeModalClose(true); resolve(true); };
              document.getElementById('confirm-no-btn').onclick = () => { playSound('click'); if(activeModalClose) activeModalClose(true); resolve(false); };
          });
        }
        
        function showAdvancedAbout() {
            const advancedAboutHTML = `
                <h2>Project Fusion: The Backstory</h2>
                <div class="scrollable-content"><div class="study-guide">
                    <p>This project, codenamed 'Fusion,' was conceived by <b>Saksham Negi</b> as a final-year project for the Computer Club. The initial goal was to create a modern, CBSE-style quiz application that was both educational and highly engaging for all age groups.</p>
                    <h4>Technical Architecture</h4>
                    <p>The core application is built on a robust, single-file HTML architecture, leveraging modern JavaScript (ES6+) for its logic engine. State management is handled through a centralized 'state' object to ensure data integrity throughout the quiz lifecycle.</p>
                    <h4>AI Integration</h4>
                    <p>To push the boundaries of an interactive quiz, Saksham integrated Google's Gemini API. This integration uses a custom-built asynchronous request handler with exponential backoff for API call stability. Gemini powers several key features:</p>
                    <ul>
                        <li><b>Procedural Content:</b> The 'Fact of the Day' and dynamic 'Guess the Place' questions are generated live, ensuring fresh content.</li>
                        <li><b>Contextual Learning Aids:</b> The 'Hint', '50/50', and 'Explain' features use Gemini's reasoning capabilities to provide helpful assistance without giving away the answer.</li>
                    </ul>
                    <h4>UI/UX Philosophy</h4>
                    <p>The user interface, refined with assistance from Gemini, focuses on fluidity and responsiveness. Animations are CSS-driven for performance, with a 'Reduce Motion' accessibility option included.</p>
                </div></div>
            `;
            showModal(advancedAboutHTML);
        }

        async function handleManageLeaderboard() { if (await promptForAdminPassword()) renderLeaderboardManager(); }
        
        function renderLeaderboardManager() {
            let leaderboard = [];
            try { leaderboard = JSON.parse(localStorage.getItem('himachalQuizLeaderboard')) || []; } catch(e) { console.error("Leaderboard parse error", e); }
            
            let managerHTML = `<h2>Manage Leaderboard</h2><div class="scrollable-content">`;
            if (leaderboard.length === 0) { managerHTML += `<p>Leaderboard is empty.</p>`; } 
            else {
                managerHTML += leaderboard.map((entry, index) => `
                    <div class="settings-row">
                        <span>${index + 1}. ${entry.name} - ${entry.score}</span>
                        <div class="btn-group">
                            <button class="secondary-btn edit-score-btn" data-index="${index}">Edit</button>
                            <button class="danger-btn delete-score-btn" data-index="${index}">Delete</button>
                        </div>
                    </div>`).join('');
            }
            
            showModal(managerHTML + '</div>');
            document.querySelectorAll('.delete-score-btn').forEach(btn => {
                btn.onclick = (e) => {
                    playSound('click', 'C3');
                    const i = parseInt(e.target.closest('button').dataset.index, 10);
                    leaderboard.splice(i, 1);
                    localStorage.setItem('himachalQuizLeaderboard', JSON.stringify(leaderboard));
                    renderLeaderboardManager(); 
                    displayLeaderboard(elements.leaderboardArea, true);
                    displayLeaderboard(elements.resultsLeaderboardArea, false);
                };
            });
            document.querySelectorAll('.edit-score-btn').forEach(btn => {
                btn.onclick = (e) => { 
                    playSound('click');
                    const i = parseInt(e.target.closest('button').dataset.index, 10); 
                    handleEditScore(i, leaderboard[i]); 
                };
            });
        }
        
        async function handleEditScore(index, entry) {
            return new Promise(resolve => {
                showModal(`<h2>Edit Entry</h2><div class="scrollable-content"><p>Editing score for ${entry.name}.</p><input type="text" id="edit-name-input" class="modal-input" value="${entry.name}" placeholder="Player Name" maxlength="15"><input type="number" id="edit-score-input" class="modal-input" value="${entry.score}" placeholder="Score"><div id="modal-validation-message"></div><div class="modal-buttons"><button id="edit-save-btn" class="main-btn">Save</button></div></div>`);
                document.getElementById('edit-save-btn').onclick = () => {
                    playSound('click');
                    const nameInput = document.getElementById('edit-name-input'), scoreInput = document.getElementById('edit-score-input');
                    const newName = nameInput.value.trim(), newScore = scoreInput.value;
                    if (!newName) { document.getElementById('modal-validation-message').textContent = 'Name cannot be empty.'; return; }
                    let lb = JSON.parse(localStorage.getItem('himachalQuizLeaderboard')) || [];
                    lb[index] = { name: newName, score: parseInt(newScore, 10) || 0 };
                    lb.sort((a, b) => b.score - a.score);
                    localStorage.setItem('himachalQuizLeaderboard', JSON.stringify(lb));
                    if(activeModalClose) activeModalClose(true);
                    renderLeaderboardManager(); 
                    displayLeaderboard(elements.leaderboardArea, true); 
                    displayLeaderboard(elements.resultsLeaderboardArea, false);
                    resolve();
                };
            });
        }

        async function handleMasterReset() {
            if (!await promptForAdminPassword()) return;
            if (await showConfirmation("This will delete the ENTIRE leaderboard and ALL settings. This action cannot be undone.")) {
                try {
                    localStorage.removeItem('himachalQuizLeaderboard');
                    localStorage.removeItem('quizSettings');
                    await showAlert(`<h2>Reset Complete</h2><p>All quiz data has been deleted. The application will now reload.</p>`);
                    setTimeout(() => window.location.reload(), 2000);
                } catch(e) { await showAlert(`<h2>Error</h2><p>An error occurred while clearing data.</p>`); }
            }
        }
        
        // --- BIND EVENTS & INITIALIZE ---
        function bindEvents() {
            const playClick = () => {
                playSound('click');
            };
            elements.startBtn.addEventListener('click', () => { playClick(); startGame(); });
            elements.nextBtn.addEventListener('click', () => { playClick(); loadNextQuestion(); });
            elements.aboutBtn.addEventListener('click', (e) => { e.preventDefault(); playClick(); showAdvancedAbout(); });
            elements.settingsBtn.addEventListener('click', (e) => { e.preventDefault(); playClick(); showSettingsModal(); });
            elements.studyGuideBtn.addEventListener('click', (e) => { e.preventDefault(); playClick(); showStudyGuide(); });
            elements.hintBtn.addEventListener('click', () => { playClick(); getHint(); });
            elements.powerup5050Btn.addEventListener('click', () => { playClick(); useFiftyFifty(); });
        }
        
        // Initial App Load / Audio Initializer
        function initAudioOnFirstInteraction() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            document.body.removeEventListener('click', initAudioOnFirstInteraction);
            document.body.removeEventListener('touchend', initAudioOnFirstInteraction);
        }
        document.body.addEventListener('click', initAudioOnFirstInteraction);
        document.body.addEventListener('touchend', initAudioOnFirstInteraction);

        goHome();
        fetchFactOfTheDay();
        setupSounds();
        bindEvents();

    });
  </script>
</body>
</html>

